# Arquitectura del Microservicio de Scraping

## ğŸ“‹ Tabla de Contenidos

1. [VisiÃ³n General](#visiÃ³n-general)
2. [Arquitectura del Sistema](#arquitectura-del-sistema)
3. [Diagramas de Secuencia](#diagramas-de-secuencia)
4. [EvoluciÃ³n: Navegador Remoto](#evoluciÃ³n-navegador-remoto)
5. [Stack TecnolÃ³gico](#stack-tecnolÃ³gico)
6. [Opciones de ImplementaciÃ³n](#opciones-de-implementaciÃ³n)
7. [API REST](#api-rest)
8. [IntegraciÃ³n con Spring](#integraciÃ³n-con-spring)
9. [Despliegue en Railway](#despliegue-en-railway)
10. [Estructura de Archivos en SFTP](#estructura-de-archivos-en-sftp)
11. [Decisiones de DiseÃ±o](#decisiones-de-diseÃ±o)
12. [Plan de MigraciÃ³n](#plan-de-migraciÃ³n)

---

## ğŸ¯ VisiÃ³n General

El microservicio de scraping es un componente **independiente** que expone una API REST para automatizar el proceso de:

1. **Scraping** de PDFs desde Cruz Blanca
2. **ExtracciÃ³n** de datos estructurados (JSON)
3. **GeneraciÃ³n** de reportes consolidados (CSV)

El microservicio opera en modo **"Fire and Forget"**:
- La aplicaciÃ³n Spring **gatilla** el proceso
- El microservicio **procesa en background**
- Los resultados se **guardan automÃ¡ticamente en SFTP**
- Spring **lee los archivos** cuando los necesita

---

## ğŸ—ï¸ Arquitectura del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ APLICACIÃ“N SPRING (Cliente)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Usuario: "Procesar Febrero 2025"                           â”‚
â”‚         â”‚                                                    â”‚
â”‚         â”‚ POST /api/v1/scraping/trigger                     â”‚
â”‚         â”‚ {year: 2025, month: "FEBRERO", prestador: "..."} â”‚
â”‚         â–¼                                                    â”‚
â”‚  RestTemplate.post(...)                                     â”‚
â”‚         â”‚                                                    â”‚
â”‚         â”‚ Response: 202 Accepted                            â”‚
â”‚         â”‚ {job_id: "febrero_2025_xxx", message: "started"} â”‚
â”‚         â–¼                                                    â”‚
â”‚  "Proceso iniciado, archivos disponibles en 5-10 min"      â”‚
â”‚                                                              â”‚
â”‚  ... (usuario espera 5-10 minutos) ...                     â”‚
â”‚                                                              â”‚
â”‚  Usuario: "Ver reporte Febrero"                            â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚  Lee desde SFTP o API:                                      â”‚
â”‚  GET /api/v1/files/febrero_2025/reports/consolidado.csv    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ HTTPS
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MICROSERVICIO DE SCRAPING (Railway)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ API REST (FastAPI)                                     â”‚ â”‚
â”‚  â”‚ - POST /trigger â†’ Encola job, response inmediato      â”‚ â”‚
â”‚  â”‚ - GET /files/{path} â†’ Download archivos (opcional)    â”‚ â”‚
â”‚  â”‚ - GET /completed â†’ Lista jobs terminados (opcional)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚                                    â”‚
â”‚                         â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Task Queue (Upstash Redis + RQ/Celery)                â”‚ â”‚
â”‚  â”‚ - Encola jobs                                          â”‚ â”‚
â”‚  â”‚ - Retry automÃ¡tico                                     â”‚ â”‚
â”‚  â”‚ - Persistencia                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚                                    â”‚
â”‚                         â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Background Workers                                     â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚ Pipeline de 3 pasos:                                   â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚ 1ï¸âƒ£  SCRAPER (2-3 min)                                 â”‚ â”‚
â”‚  â”‚     - Playwright + Manual CAPTCHA                      â”‚ â”‚
â”‚  â”‚     - Descarga PDFs                                    â”‚ â”‚
â”‚  â”‚     - Guarda en SFTP: /pdfs/                          â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚ 2ï¸âƒ£  EXTRACTOR (1-2 min)                               â”‚ â”‚
â”‚  â”‚     - Lee PDFs desde SFTP                              â”‚ â”‚
â”‚  â”‚     - pdfplumber â†’ JSON                                â”‚ â”‚
â”‚  â”‚     - ValidaciÃ³n con schema                            â”‚ â”‚
â”‚  â”‚     - Guarda en SFTP: /json/                          â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚ 3ï¸âƒ£  REPORTER (30 seg)                                 â”‚ â”‚
â”‚  â”‚     - Lee JSONs desde SFTP                             â”‚ â”‚
â”‚  â”‚     - Genera CSV consolidado                           â”‚ â”‚
â”‚  â”‚     - Guarda en SFTP: /reports/                       â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚                                    â”‚
â”‚                         â–¼                                    â”‚
â”‚              Todos los archivos en SFTP                     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ SFTP Protocol
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STORAGE (Digital Ocean SFTP)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  /scraping_data/                                            â”‚
â”‚  â”œâ”€â”€ febrero_2025_1234567/                                  â”‚
â”‚  â”‚   â”œâ”€â”€ pdfs/                                              â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ row_1_19_xxx.pdf                              â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ row_2_19_xxx.pdf                              â”‚
â”‚  â”‚   â”‚   â””â”€â”€ ... (57 archivos)                             â”‚
â”‚  â”‚   â”œâ”€â”€ json/                                              â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ row_1_19_xxx.json                             â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ row_2_19_xxx.json                             â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ ... (57 archivos)                             â”‚
â”‚  â”‚   â”‚   â””â”€â”€ _reporte_extraccion.json                      â”‚
â”‚  â”‚   â”œâ”€â”€ reports/                                           â”‚
â”‚  â”‚   â”‚   â””â”€â”€ consolidado.csv                                â”‚
â”‚  â”‚   â””â”€â”€ metadata/                                          â”‚
â”‚  â”‚       â”œâ”€â”€ job_info.json                                  â”‚
â”‚  â”‚       â””â”€â”€ scraping_metadata.csv                          â”‚
â”‚  â”œâ”€â”€ marzo_2025_1234568/                                    â”‚
â”‚  â”‚   â””â”€â”€ ...                                                â”‚
â”‚  â””â”€â”€ abril_2025_1234569/                                    â”‚
â”‚      â””â”€â”€ ...                                                â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Diagramas de Secuencia

### Escenario A: Con Observabilidad (Polling de Estado)

En este escenario, Spring puede consultar el estado del proceso en tiempo real para mostrar progreso al usuario.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Usuario â”‚     â”‚ Spring  â”‚     â”‚ Scraper API  â”‚     â”‚  Redis  â”‚     â”‚ Worker  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚ (1) Trigger   â”‚                  â”‚                  â”‚               â”‚
     â”‚ "Procesar     â”‚                  â”‚                  â”‚               â”‚
     â”‚  Febrero 2025"â”‚                  â”‚                  â”‚               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚ POST /api/v1/scraping/trigger      â”‚               â”‚
     â”‚               â”‚ {year, month, prestador}           â”‚               â”‚
     â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚ Enqueue job     â”‚               â”‚
     â”‚               â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚ job_id created  â”‚               â”‚
     â”‚               â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚ 202 Accepted     â”‚                  â”‚               â”‚
     â”‚               â”‚ {job_id, status: "pending"}        â”‚               â”‚
     â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚ "Proceso      â”‚                  â”‚                  â”‚               â”‚
     â”‚  iniciado...  â”‚                  â”‚                  â”‚               â”‚
     â”‚  Job ID: XXX" â”‚                  â”‚                  â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚ (2) Dequeue  â”‚
     â”‚               â”‚                  â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”œâ”€â”
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ (3) Scraping
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ - Launch browser
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ - Login (manual)
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ - Download PDFs
     â”‚               â”‚                  â”‚                  â”‚               â”‚â—„â”˜
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚ Update:      â”‚
     â”‚               â”‚                  â”‚                  â”‚ "scraping"   â”‚
     â”‚               â”‚                  â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚ (4) Poll status  â”‚                  â”‚               â”‚
     â”‚               â”‚ GET /api/v1/scraping/jobs/{job_id} â”‚               â”‚
     â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚ Get status       â”‚               â”‚
     â”‚               â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚ {status, prog..} â”‚               â”‚
     â”‚               â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚ 200 OK           â”‚                  â”‚               â”‚
     â”‚               â”‚ {status: "scraping", progress: 30%}â”‚               â”‚
     â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚ (5) Show      â”‚                  â”‚                  â”‚               â”‚
     â”‚ progress:     â”‚                  â”‚                  â”‚               â”‚
     â”‚ "Descargando  â”‚                  â”‚                  â”‚               â”‚
     â”‚  PDFs 30%"    â”‚                  â”‚                  â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”œâ”€â”
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ (6) Upload PDFs
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚     to SFTP
     â”‚               â”‚                  â”‚                  â”‚               â”‚â—„â”˜
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚ Update:      â”‚
     â”‚               â”‚                  â”‚                  â”‚ "extracting" â”‚
     â”‚               â”‚                  â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚ (7) Poll status  â”‚                  â”‚               â”‚
     â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚ Get status       â”‚               â”‚
     â”‚               â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚                  â”‚ {status, prog..} â”‚               â”‚
     â”‚               â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
     â”‚               â”‚ {status: "extracting", progress: 60%}              â”‚
     â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚ "Extrayendo   â”‚                  â”‚                  â”‚               â”‚
     â”‚  datos 60%"   â”‚                  â”‚                  â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”œâ”€â”
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ (8) Extract JSONs
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚     & Upload
     â”‚               â”‚                  â”‚                  â”‚               â”‚â—„â”˜
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚ Update:      â”‚
     â”‚               â”‚                  â”‚                  â”‚ "reporting"  â”‚
     â”‚               â”‚                  â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”œâ”€â”
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ (9) Generate CSV
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚     & Upload
     â”‚               â”‚                  â”‚                  â”‚               â”‚â—„â”˜
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚ Update:      â”‚
     â”‚               â”‚                  â”‚                  â”‚ "completed"  â”‚
     â”‚               â”‚                  â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚ (10) Poll status â”‚                  â”‚               â”‚
     â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚ Get status       â”‚               â”‚
     â”‚               â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚                  â”‚ {status: "comp"} â”‚               â”‚
     â”‚               â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
     â”‚               â”‚ {status: "completed", files: 57}    â”‚               â”‚
     â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚ "Proceso      â”‚                  â”‚                  â”‚               â”‚
     â”‚  completado!  â”‚                  â”‚                  â”‚               â”‚
     â”‚  Ver reporte" â”‚                  â”‚                  â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚ (11) Click    â”‚                  â”‚                  â”‚               â”‚
     â”‚ "Ver reporte" â”‚                  â”‚                  â”‚               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚ GET /api/v1/files/{job_id}/reports/consolidado.csv â”‚
     â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”œâ”€â”                â”‚               â”‚
     â”‚               â”‚                  â”‚ â”‚ Download       â”‚               â”‚
     â”‚               â”‚                  â”‚ â”‚ from SFTP      â”‚               â”‚
     â”‚               â”‚                  â”‚â—„â”˜                â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚ 200 OK [CSV]     â”‚                  â”‚               â”‚
     â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚ [CSV File]    â”‚                  â”‚                  â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
```

**CaracterÃ­sticas:**
- âœ… Feedback en tiempo real al usuario
- âœ… Progress bar / spinner
- âœ… DetecciÃ³n de fallos inmediata
- âŒ MÃ¡s complejo (polling cada 5s)
- âŒ MÃ¡s requests HTTP

---

### Escenario B: Sin Observabilidad (Fire & Forget)

En este escenario (mÃ¡s simple), Spring solo gatilla el proceso y el usuario espera sin feedback.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Usuario â”‚     â”‚ Spring  â”‚     â”‚ Scraper API  â”‚     â”‚  Redis  â”‚     â”‚ Worker  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚ (1) Trigger   â”‚                  â”‚                  â”‚               â”‚
     â”‚ "Procesar     â”‚                  â”‚                  â”‚               â”‚
     â”‚  Febrero 2025"â”‚                  â”‚                  â”‚               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚ POST /api/v1/scraping/trigger      â”‚               â”‚
     â”‚               â”‚ {year, month, prestador}           â”‚               â”‚
     â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚ Enqueue job     â”‚               â”‚
     â”‚               â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚ job_id created  â”‚               â”‚
     â”‚               â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚ 202 Accepted     â”‚                  â”‚               â”‚
     â”‚               â”‚ {                â”‚                  â”‚               â”‚
     â”‚               â”‚   job_id: "febrero_2025_xxx",      â”‚               â”‚
     â”‚               â”‚   message: "Proceso iniciado",     â”‚               â”‚
     â”‚               â”‚   estimated_time: "5-10 min",      â”‚               â”‚
     â”‚               â”‚   sftp_path: "/scraping_data/..."  â”‚               â”‚
     â”‚               â”‚ }                â”‚                  â”‚               â”‚
     â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚ "Proceso      â”‚                  â”‚                  â”‚               â”‚
     â”‚  iniciado.    â”‚                  â”‚                  â”‚               â”‚
     â”‚  Los archivos â”‚                  â”‚                  â”‚               â”‚
     â”‚  estarÃ¡n      â”‚                  â”‚                  â”‚               â”‚
     â”‚  disponibles  â”‚                  â”‚                  â”‚               â”‚
     â”‚  en 5-10 min" â”‚                  â”‚                  â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚   [FIN DE LA INTERACCIÃ“N]        â”‚                  â”‚               â”‚
     â”‚                                  â”‚                  â”‚               â”‚
     â”‚                                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚ (2) Dequeue  â”‚
     â”‚               â”‚                  â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”œâ”€â”
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ (3) SCRAPING
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ - Launch Playwright
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ - Login manual
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ - NavegaciÃ³n
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ - Download 57 PDFs
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ - ~2-3 minutos
     â”‚               â”‚                  â”‚                  â”‚               â”‚â—„â”˜
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”œâ”€â”
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ Upload to SFTP:
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ /pdfs/*.pdf
     â”‚               â”‚                  â”‚                  â”‚               â”‚â—„â”˜
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”œâ”€â”
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ (4) EXTRACTION
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ - Read PDFs from SFTP
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ - pdfplumber parse
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ - Validate schema
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ - Generate JSONs
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ - ~1-2 minutos
     â”‚               â”‚                  â”‚                  â”‚               â”‚â—„â”˜
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”œâ”€â”
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ Upload to SFTP:
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ /json/*.json
     â”‚               â”‚                  â”‚                  â”‚               â”‚â—„â”˜
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”œâ”€â”
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ (5) REPORTING
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ - Read JSONs
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ - Generate CSV
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ - Consolidate data
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ - ~30 segundos
     â”‚               â”‚                  â”‚                  â”‚               â”‚â—„â”˜
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”œâ”€â”
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ Upload to SFTP:
     â”‚               â”‚                  â”‚                  â”‚               â”‚ â”‚ /reports/consolidado.csv
     â”‚               â”‚                  â”‚                  â”‚               â”‚â—„â”˜
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚ Mark completeâ”‚
     â”‚               â”‚                  â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚   ... (5-10 minutos despuÃ©s) ...                   â”‚               â”‚
     â”‚                                                     â”‚               â”‚
     â”‚ (6) Usuario   â”‚                  â”‚                  â”‚               â”‚
     â”‚ solicita      â”‚                  â”‚                  â”‚               â”‚
     â”‚ "Ver reporte  â”‚                  â”‚                  â”‚               â”‚
     â”‚  Febrero"     â”‚                  â”‚                  â”‚               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚               â”œâ”€â”                â”‚                  â”‚               â”‚
     â”‚               â”‚ â”‚ Read from SFTP â”‚                  â”‚               â”‚
     â”‚               â”‚ â”‚ /scraping_data/febrero_2025/     â”‚               â”‚
     â”‚               â”‚ â”‚ reports/consolidado.csv          â”‚               â”‚
     â”‚               â”‚â—„â”˜                â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
     â”‚ [CSV Data]    â”‚                  â”‚                  â”‚               â”‚
     â”‚ + UI Table    â”‚                  â”‚                  â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                  â”‚               â”‚
     â”‚               â”‚                  â”‚                  â”‚               â”‚
```

**CaracterÃ­sticas:**
- âœ… MÃ¡xima simplicidad
- âœ… Sin polling (menos requests)
- âœ… Menor carga en Redis
- âœ… MÃ¡s escalable
- âŒ Sin feedback en tiempo real
- âŒ Usuario no sabe si fallÃ³ hasta revisar SFTP

---

### ComparaciÃ³n de Escenarios

| Aspecto | Con Observabilidad | Sin Observabilidad |
|---------|-------------------|-------------------|
| **Complejidad** | Media | Baja |
| **Requests HTTP** | ~60-120 (polling cada 5s) | 2 (trigger + download) |
| **UX** | â­â­â­â­â­ (feedback en vivo) | â­â­â­ (espera ciega) |
| **Escalabilidad** | Media (mÃ¡s carga Redis) | Alta (stateless) |
| **DetecciÃ³n errores** | Inmediata | Diferida (al ver SFTP) |
| **ImplementaciÃ³n** | API + Polling logic | Solo trigger |
| **Uso Redis** | Alto (updates frecuentes) | Bajo (solo queue) |

### RecomendaciÃ³n

**Fase 1 (MVP):** Implementar **Sin Observabilidad** (Escenario B)
- MÃ¡s rÃ¡pido de desarrollar
- Suficiente para usuarios tÃ©cnicos
- Menos moving parts

**Fase 2 (ProducciÃ³n):** Agregar **Con Observabilidad** (Escenario A)
- Mejor UX
- Monitoreo de jobs
- DetecciÃ³n temprana de errores

---

## ğŸš€ EvoluciÃ³n: Navegador Remoto

### VisiÃ³n a Futuro

La arquitectura actual (Fase 1) requiere que el usuario tenga Playwright instalado localmente y resuelva el CAPTCHA en su navegador local. La **arquitectura objetivo** elimina esta dependencia usando un **navegador remoto controlado por el backend**.

---

### ComparaciÃ³n: Estado Actual vs Estado Objetivo

| Aspecto | **Estado Actual (Fase 1)** | **Estado Objetivo (Fase 2+)** |
|---------|---------------------------|------------------------------|
| **Login/CAPTCHA** | Usuario abre navegador local | Usuario ve viewer del Chrome remoto |
| **InstalaciÃ³n** | Requiere Playwright local | Sin instalaciÃ³n en PC usuario |
| **Control** | Limitado | Backend tiene control total |
| **SesiÃ³n** | No se guarda | storageState reutilizable |
| **Headless** | No (requiere UI) | SÃ­ (worker 100% headless) |
| **Escalabilidad** | 1 usuario a la vez | MÃºltiples sesiones paralelas |
| **Complejidad** | Baja | Media-Alta |
| **Infraestructura** | Solo Railway + Redis | + Navegador remoto (Browserless/self-host) |

---

### Arquitectura con Navegador Remoto

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ARQUITECTURA OBJETIVO - NAVEGADOR REMOTO                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. USUARIO + SPRING                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Usuario                                                                 â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â”‚ Clic "Procesar Febrero 2025"                                      â”‚
â”‚     â–¼                                                                    â”‚
â”‚  Spring Backend                                                          â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â”‚ POST /run                                                          â”‚
â”‚     â”‚ {client_id, site_id, params}                                      â”‚
â”‚     â–¼                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ HTTPS
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. SCRAPER API (FastAPI)                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  POST /run                                                               â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â”œâ”€â–º Crear sesiÃ³n Chrome remoto                                      â”‚
â”‚     â”‚   (Browserless/Browserbase o self-host)                           â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â”œâ”€â–º Generar login_url (viewer)                                      â”‚
â”‚     â”‚   https://viewer.sesion-remota/abc123                             â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â””â”€â–º Response: {login_url, session_id}                               â”‚
â”‚                                                                          â”‚
â”‚  Spring recibe login_url                                                â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â””â”€â–º Abre popup window(login_url)                                    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. VIEWER (Popup) + CHROME REMOTO                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Popup Window (viewer)                                    â”‚           â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚           â”‚
â”‚  â”‚ â”‚                                                     â”‚   â”‚           â”‚
â”‚  â”‚ â”‚   [Stream del Chrome Remoto via WebRTC/noVNC]     â”‚   â”‚           â”‚
â”‚  â”‚ â”‚                                                     â”‚   â”‚           â”‚
â”‚  â”‚ â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚           â”‚
â”‚  â”‚ â”‚   â”‚ Cruz Blanca - Login                     â”‚     â”‚   â”‚           â”‚
â”‚  â”‚ â”‚   â”‚                                         â”‚     â”‚   â”‚           â”‚
â”‚  â”‚ â”‚   â”‚ Usuario: [____________]                 â”‚     â”‚   â”‚           â”‚
â”‚  â”‚ â”‚   â”‚ Clave:   [____________]                 â”‚     â”‚   â”‚           â”‚
â”‚  â”‚ â”‚   â”‚                                         â”‚     â”‚   â”‚           â”‚
â”‚  â”‚ â”‚   â”‚ [reCAPTCHA]                             â”‚     â”‚   â”‚           â”‚
â”‚  â”‚ â”‚   â”‚                                         â”‚     â”‚   â”‚           â”‚
â”‚  â”‚ â”‚   â”‚ [Iniciar SesiÃ³n]                        â”‚     â”‚   â”‚           â”‚
â”‚  â”‚ â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚           â”‚
â”‚  â”‚ â”‚                                                     â”‚   â”‚           â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                          â”‚                                               â”‚
â”‚                          â”‚ Usuario interactÃºa                            â”‚
â”‚                          â”‚ (input + CAPTCHA)                             â”‚
â”‚                          â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Chrome Remoto (Headful)                                  â”‚           â”‚
â”‚  â”‚ - Corriendo en servidor backend                          â”‚           â”‚
â”‚  â”‚ - Playwright conectado                                   â”‚           â”‚
â”‚  â”‚ - Scraper API controla TODO                              â”‚           â”‚
â”‚  â”‚ - Detecta login OK (URL/selector)                        â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                          â”‚                                               â”‚
â”‚                          â”‚ Login exitoso                                â”‚
â”‚                          â–¼                                               â”‚
â”‚                   storageState()                                         â”‚
â”‚                   (cookies, localStorage)                                â”‚
â”‚                          â”‚                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ Guardar en Redis
                           â”‚ (cifrado, TTL 1h)
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. WORKER (Headless con storageState)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Pipeline Automatizado (100% headless)                       â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚                                                              â”‚        â”‚
â”‚  â”‚  1ï¸âƒ£  SCRAPING                                               â”‚        â”‚
â”‚  â”‚      - Playwright headless                                  â”‚        â”‚
â”‚  â”‚      - context.add_cookies(storageState)                    â”‚        â”‚
â”‚  â”‚      - Ya autenticado (no login)                            â”‚        â”‚
â”‚  â”‚      - Navega pÃ¡ginas privadas                              â”‚        â”‚
â”‚  â”‚      - Descarga PDFs (bytes en memoria)                     â”‚        â”‚
â”‚  â”‚      - Sube a SFTP: /pdfs/                                  â”‚        â”‚
â”‚  â”‚                                                              â”‚        â”‚
â”‚  â”‚  2ï¸âƒ£  EXTRACTION                                             â”‚        â”‚
â”‚  â”‚      - Lee PDFs desde SFTP                                  â”‚        â”‚
â”‚  â”‚      - pdfplumber â†’ JSON                                    â”‚        â”‚
â”‚  â”‚      - ValidaciÃ³n schema                                    â”‚        â”‚
â”‚  â”‚      - Sube a SFTP: /json/                                  â”‚        â”‚
â”‚  â”‚                                                              â”‚        â”‚
â”‚  â”‚  3ï¸âƒ£  REPORTING                                              â”‚        â”‚
â”‚  â”‚      - Consolida JSONs â†’ CSV                                â”‚        â”‚
â”‚  â”‚      - Sube a SFTP: /reports/                               â”‚        â”‚
â”‚  â”‚      - Persiste en BD (PostgreSQL)                          â”‚        â”‚
â”‚  â”‚                                                              â”‚        â”‚
â”‚  â”‚  âœ… Pipeline completo sin intervenciÃ³n                       â”‚        â”‚
â”‚  â”‚                                                              â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                    Datos finales en BD + SFTP
```

---

### Flujo Detallado con Navegador Remoto

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”
â”‚ Usuario â”‚  â”‚ Spring  â”‚  â”‚ Scraper  â”‚  â”‚  Viewer  â”‚  â”‚ Chrome  â”‚  â”‚ Worker â”‚  â”‚ DB  â”‚
â”‚         â”‚  â”‚         â”‚  â”‚   API    â”‚  â”‚ (Popup)  â”‚  â”‚ Remoto  â”‚  â”‚        â”‚  â”‚     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚ (1) Clic   â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚ "Procesar" â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚ POST /run   â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚ {params}    â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚ (2) Create  â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚ Remote      â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚ Browser     â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚          Chrome          â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚          launched        â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚ (3) Generateâ”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚ login_url   â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚ + session_idâ”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚ 202 Acceptedâ”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚ {login_url} â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚ (4) Open    â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚ popup       â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚          window.open()    â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚ (5) Ve     â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚ Chrome     â”‚             â”‚             â”‚ WebRTC/     â”‚            â”‚          â”‚
     â”‚ remoto     â”‚             â”‚             â”‚ noVNC       â”‚            â”‚          â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚ stream      â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚ (6) Input  â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚ usuario +  â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚ CAPTCHA    â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚          Login OK        â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚ (7) Detect  â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚ login OK    â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚          â”‚
     â”‚            â”‚             â”‚ (URL/selector)             â”‚          â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚ (8) Capture â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚ storageStateâ”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚          cookies         â”‚          â”‚
     â”‚            â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚ (9) Save to â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚ Redis       â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚ (encrypted) â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚ (10) Enqueueâ”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚ Worker      â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚         {storageState}â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚ (11) Close â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚ popup      â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚            â”‚          â”‚
     â”‚ "Procesandoâ”‚             â”‚          Close viewer      â”‚            â”‚          â”‚
     â”‚  en        â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚  background"â”‚            â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”œâ”€â”        â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚ â”‚ (12)   â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚ â”‚ Scrape â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚ â”‚headlessâ”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚ â”‚+storageâ”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚â—„â”˜        â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”œâ”€â”        â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚ â”‚ (13)   â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚ â”‚Extract â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚ â”‚PDFs    â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚â—„â”˜        â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”œâ”€â”        â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚ â”‚ (14)   â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚ â”‚Generateâ”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚ â”‚CSV     â”‚
     â”‚            â”‚             â”‚             â”‚            â”‚â—„â”˜        â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚ (15)     â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚ Persist  â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚   INSERT â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚   OK     â”‚
     â”‚            â”‚             â”‚             â”‚             â”‚            â”‚          â”‚
     â”‚   FIN - Datos en BD                   â”‚             â”‚            â”‚          â”‚
     â”‚                                                                              â”‚
```

---

### Ventajas del Navegador Remoto

#### 1. **Zero Install en Cliente**
- âŒ Ya no: "Instala Playwright en tu PC"
- âœ… Ahora: Solo navegador web estÃ¡ndar

#### 2. **Control Total del Backend**
- Backend controla 100% el navegador
- Puede debuggear, hacer screenshots, logs
- Puede reintentar automÃ¡ticamente

#### 3. **SesiÃ³n Reutilizable**
- `storageState` se guarda en Redis
- Worker puede reusar la sesiÃ³n (hasta expiraciÃ³n)
- Posibilidad de scraping recurrente sin re-login

#### 4. **Escalabilidad**
- MÃºltiples usuarios simultÃ¡neos
- Pool de navegadores remotos
- Aislamiento por sesiÃ³n

#### 5. **Headless Real**
- Worker corre 100% headless
- Sin necesidad de UI en servidor
- MÃ¡s rÃ¡pido y eficiente

---

### Proveedores de Navegador Remoto

#### OpciÃ³n A: Browserless/Browserbase (Gestionado)

**Browserless.io**
```
Pros:
- Setup en minutos
- Mantenimiento cero
- API simple
- WebSocket/noVNC built-in
- $79/mes (starter)

Contras:
- Costo recurrente
- LÃ­mites de concurrencia
```

**Browserbase**
```
Pros:
- Similar a Browserless
- Optimizado para Playwright
- $49/mes (starter)

Contras:
- Menos features de viewer
```

---

#### OpciÃ³n B: Self-Host (Docker)

**Stack:**
```dockerfile
# docker-compose.yml
services:
  chrome-remote:
    image: browserless/chrome:latest
    ports:
      - "3000:3000"
    environment:
      - MAX_CONCURRENT_SESSIONS=10
      - CONNECTION_TIMEOUT=300000
    
  novnc:
    image: theasp/novnc:latest
    ports:
      - "8080:8080"
    depends_on:
      - chrome-remote
```

**Pros:**
- Sin costo (solo infra)
- Control total
- Sin lÃ­mites

**Contras:**
- Mantenimiento
- Escalar manualmente
- Seguridad a cargo tuyo

---

### ImplementaciÃ³n del Endpoint `/run`

```python
from fastapi import FastAPI
from playwright.async_api import async_playwright
import redis
import json

app = FastAPI()
redis_client = redis.from_url(REDIS_URL)

@app.post("/run")
async def run(payload: RunPayload):
    """
    Endpoint Ãºnico que:
    1. Crea sesiÃ³n Chrome remoto
    2. Retorna login_url
    3. Dispara pipeline en background
    """
    # 1. Crear sesiÃ³n en proveedor remoto
    session = await create_remote_browser_session(
        client_id=payload.client_id,
        site_id=payload.site_id
    )
    
    login_url = session.viewer_url  # WebRTC/noVNC URL
    session_id = session.id
    
    # 2. Guardar session_id en Redis
    redis_client.setex(
        f"session:{session_id}",
        3600,  # 1 hora TTL
        json.dumps({"client_id": payload.client_id, "params": payload.params})
    )
    
    # 3. Disparar orquestador en background
    background_tasks.add_task(orchestrate, session_id, payload)
    
    # 4. Response inmediato
    return {
        "login_url": login_url,
        "session_id": session_id,
        "message": "Abrir popup y completar login. El proceso continÃºa automÃ¡tico."
    }

async def orchestrate(session_id: str, payload: RunPayload):
    """
    Orquestador que espera login OK y ejecuta pipeline
    """
    try:
        # 1. Esperar login exitoso (polling interno)
        storage_state = await wait_for_login_and_capture(
            session_id, 
            timeout_minutes=15
        )
        
        # 2. Guardar storageState cifrado en Redis
        encrypted_state = encrypt(json.dumps(storage_state))
        redis_client.setex(
            f"storage:{session_id}",
            3600,
            encrypted_state
        )
        
        # 3. Ejecutar pipeline con storageState
        await run_pipeline_with_storage(
            storage_state=storage_state,
            params=payload.params,
            client_id=payload.client_id
        )
        
    except TimeoutError:
        log.error(f"Login timeout para session {session_id}")
        # Notificar a usuario (webhook/email)
    
    finally:
        # 4. Cleanup
        await close_remote_browser_session(session_id)

async def wait_for_login_and_capture(session_id: str, timeout_minutes: int):
    """
    Polling interno: detecta login OK y captura storageState
    """
    async with async_playwright() as p:
        browser = await p.chromium.connect_over_cdp(
            f"ws://browserless:3000?token={session_id}"
        )
        context = browser.contexts[0]
        page = context.pages[0]
        
        # Esperar seÃ±al de login OK
        # OpciÃ³n 1: URL cambiÃ³
        # OpciÃ³n 2: Selector especÃ­fico aparece
        await page.wait_for_url("**/home.aspx", timeout=timeout_minutes*60*1000)
        
        # Capturar storageState
        storage_state = await context.storage_state()
        
        return storage_state

async def run_pipeline_with_storage(storage_state, params, client_id):
    """
    Worker headless con storageState inyectado
    """
    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=True)
        
        # Inyectar storageState
        context = await browser.new_context(storage_state=storage_state)
        page = await context.new_page()
        
        # Ya estamos autenticados!
        await page.goto("https://cruzblanca.cl/privado.aspx")
        
        # 1. Scrape PDFs
        pdfs = await scrape_pdfs(page, params)
        
        # 2. Extract
        jsons = [extract_pdf(pdf) for pdf in pdfs]
        
        # 3. Report + Persist
        csv = generate_csv(jsons)
        persist_to_db(jsons, csv, client_id)
        
        await browser.close()
```

---

### Seguridad del storageState

**CrÃ­tico:** `storageState` contiene cookies de sesiÃ³n activas.

```python
from cryptography.fernet import Fernet

# En settings
ENCRYPTION_KEY = Fernet.generate_key()  # Guardar en env
cipher = Fernet(ENCRYPTION_KEY)

def encrypt(data: str) -> bytes:
    return cipher.encrypt(data.encode())

def decrypt(encrypted: bytes) -> str:
    return cipher.decrypt(encrypted).decode()

# Uso
encrypted_state = encrypt(json.dumps(storage_state))
redis_client.setex(f"storage:{session_id}", 3600, encrypted_state)

# Recovery
encrypted_state = redis_client.get(f"storage:{session_id}")
storage_state = json.loads(decrypt(encrypted_state))
```

**Medidas adicionales:**
- TTL corto (1 hora mÃ¡x)
- Nunca exponer al frontend
- Rotar despuÃ©s de uso
- Logs de acceso

---

### Criterios de AceptaciÃ³n (POC)

Para validar que la arquitectura funciona:

#### âœ… Fase POC
1. **Login Remoto**
   - Se abre popup con viewer
   - Usuario ve el Chrome remoto (no su navegador)
   - Puede interactuar (input + CAPTCHA)

2. **Captura de SesiÃ³n**
   - Backend detecta login OK
   - Captura `storageState` correctamente
   - Se guarda cifrado en Redis

3. **Worker Headless**
   - Worker headless se conecta con `storageState`
   - Accede a pÃ¡gina privada (200 OK)
   - No necesita re-login

4. **Pipeline Completo**
   - Descarga al menos 1 PDF
   - Convierte a JSON
   - Guarda en BD
   - (Opcional) Sube a SFTP

#### âœ… Criterio de Ã‰xito
- Usuario NO instala nada
- Proceso completo end-to-end
- Datos llegan a BD

---

## ğŸ› ï¸ Stack TecnolÃ³gico

### Backend (Microservicio)

| Componente | TecnologÃ­a | PropÃ³sito |
|------------|------------|-----------|
| **API Framework** | FastAPI 0.109+ | Endpoints REST |
| **Web Scraping** | Playwright 1.42+ | AutomatizaciÃ³n browser |
| **PDF Parsing** | pdfplumber 0.10+ | ExtracciÃ³n de datos |
| **Task Queue** | RQ o Celery | Procesamiento async |
| **Broker** | Upstash Redis | Cola de tareas |
| **Storage** | SFTP (Digital Ocean) | Archivos |
| **Language** | Python 3.11 | Runtime |

### Infraestructura

| Servicio | Proveedor | Costo | PropÃ³sito |
|----------|-----------|-------|-----------|
| **Hosting** | Railway | Gratis ($5/mes crÃ©dito) | API + Workers |
| **Redis** | Upstash | Gratis (10K cmds/dÃ­a) | Task queue |
| **SFTP** | Digital Ocean | Ya existente | File storage |

### IntegraciÃ³n

| Componente | TecnologÃ­a |
|------------|------------|
| **Cliente** | Spring Boot + RestTemplate |
| **Protocolo** | HTTP/REST + SFTP |
| **Auth** | API Key (Header) |

---

## ğŸ“Š Opciones de ImplementaciÃ³n

### OpciÃ³n A: FastAPI BackgroundTasks (Simple)

**CaracterÃ­sticas:**
- âœ… Built-in en FastAPI
- âœ… Zero dependencias extra
- âœ… Deploy mÃ¡s simple
- âŒ Sin persistencia de jobs
- âŒ Sin retry automÃ¡tico
- âŒ Si Railway reinicia, se pierden jobs en progreso

**Ideal para:**
- 1-2 usuarios
- Jobs poco frecuentes
- MÃ¡xima simplicidad

**CÃ³digo:**
```python
from fastapi import FastAPI, BackgroundTasks

@app.post("/api/v1/scraping/trigger")
async def trigger(background_tasks: BackgroundTasks):
    background_tasks.add_task(run_pipeline, job_id, year, month)
    return {"status": "started", "job_id": job_id}
```

---

### OpciÃ³n B: RQ (Redis Queue) - **RECOMENDADA**

**CaracterÃ­sticas:**
- âœ… Persistencia en Redis
- âœ… Retry automÃ¡tico
- âœ… MÃ¡s ligero que Celery
- âœ… FÃ¡cil configuraciÃ³n
- âœ… Suficiente para la mayorÃ­a de casos

**Ideal para:**
- MÃºltiples usuarios
- Necesidad de retry
- Balance simplicidad/features

**CÃ³digo:**
```python
from redis import Redis
from rq import Queue

redis_conn = Redis.from_url(UPSTASH_REDIS_URL)
queue = Queue(connection=redis_conn)

@app.post("/api/v1/scraping/trigger")
async def trigger():
    job = queue.enqueue(
        run_pipeline,
        job_id, year, month,
        job_timeout='30m'
    )
    return {"job_id": job_id, "task_id": job.id}
```

**Deploy:**
```bash
# Servicio 1: API
uvicorn app.main:app --host 0.0.0.0 --port $PORT

# Servicio 2: Worker
rq worker --url $UPSTASH_REDIS_URL
```

---

### OpciÃ³n C: Celery (Robusto)

**CaracterÃ­sticas:**
- âœ… Retry automÃ¡tico avanzado
- âœ… Scheduling (cron jobs)
- âœ… Monitoreo con Flower
- âœ… Chains y grupos de tasks
- âŒ MÃ¡s complejo
- âŒ MÃ¡s recursos

**Ideal para:**
- ProducciÃ³n enterprise
- MÃºltiples tipos de jobs
- Necesidad de scheduling

**CÃ³digo:**
```python
from celery import Celery

celery_app = Celery(
    "scraping",
    broker=UPSTASH_REDIS_URL,
    backend=UPSTASH_REDIS_URL
)

@celery_app.task(bind=True)
def run_pipeline(self, job_id, year, month):
    # ...
    self.update_state(state='PROGRESS', meta={'progress': 50})
    # ...

@app.post("/api/v1/scraping/trigger")
async def trigger():
    task = run_pipeline.delay(job_id, year, month)
    return {"job_id": job_id, "task_id": task.id}
```

**Deploy:**
```bash
# Servicio 1: API
uvicorn app.main:app --host 0.0.0.0 --port $PORT

# Servicio 2: Worker
celery -A app.celery_app worker --loglevel=info
```

---

## ğŸ“¡ API REST

### Endpoints

#### 1. Trigger Scraping (Principal)

```http
POST /api/v1/scraping/trigger
Content-Type: application/json
X-API-Key: your-api-key

{
  "year": 2025,
  "month": "FEBRERO",
  "prestador": "76190254-7 - SOLUCIONES INTEGRALES EN TERAPIA RESPIRATORIA LTDA"
}
```

**Response (202 Accepted):**
```json
{
  "job_id": "febrero_2025_1729634567",
  "message": "Proceso iniciado",
  "estimated_time_minutes": 5,
  "sftp_path": "/scraping_data/febrero_2025_1729634567/"
}
```

---

#### 2. Download Archivo (Opcional)

```http
GET /api/v1/files/{job_id}/reports/consolidado.csv
X-API-Key: your-api-key
```

**Response:** CSV file

---

#### 3. Listar Jobs Completados (Opcional)

```http
GET /api/v1/scraping/completed
X-API-Key: your-api-key
```

**Response:**
```json
[
  {
    "job_id": "febrero_2025_1729634567",
    "completed_at": "2025-02-15T10:30:00Z",
    "files_count": 57,
    "csv_url": "/api/v1/files/febrero_2025_1729634567/reports/consolidado.csv"
  },
  {
    "job_id": "marzo_2025_1729634890",
    "completed_at": "2025-03-10T14:20:00Z",
    "files_count": 45,
    "csv_url": "/api/v1/files/marzo_2025_1729634890/reports/consolidado.csv"
  }
]
```

---

## â˜• IntegraciÃ³n con Spring

### Service Layer

```java
package com.empresa.service;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
@RequiredArgsConstructor
public class ScrapingService {
    
    private final RestTemplate restTemplate;
    
    @Value("${scraping.api.url}")
    private String scrapingApiUrl;
    
    @Value("${scraping.api.key}")
    private String apiKey;
    
    /**
     * Gatilla proceso de scraping (Fire & Forget)
     */
    public ScrapingResponse triggerScraping(
        int year, 
        String month, 
        String prestador
    ) {
        String url = scrapingApiUrl + "/api/v1/scraping/trigger";
        
        // Headers
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.set("X-API-Key", apiKey);
        
        // Body
        ScrapingRequest request = ScrapingRequest.builder()
            .year(year)
            .month(month)
            .prestador(prestador)
            .build();
        
        HttpEntity<ScrapingRequest> entity = new HttpEntity<>(request, headers);
        
        // POST request
        ResponseEntity<ScrapingResponse> response = restTemplate.postForEntity(
            url, 
            entity, 
            ScrapingResponse.class
        );
        
        if (response.getStatusCode().is2xxSuccessful()) {
            log.info("Scraping iniciado: {}", response.getBody().getJobId());
            return response.getBody();
        }
        
        throw new RuntimeException("Error al iniciar scraping: " + response.getStatusCode());
    }
    
    /**
     * Descarga CSV desde el microservicio
     */
    public byte[] downloadReport(String jobId) {
        String url = scrapingApiUrl + "/api/v1/files/" + jobId + "/reports/consolidado.csv";
        
        HttpHeaders headers = new HttpHeaders();
        headers.set("X-API-Key", apiKey);
        
        HttpEntity<Void> entity = new HttpEntity<>(headers);
        
        ResponseEntity<byte[]> response = restTemplate.exchange(
            url,
            HttpMethod.GET,
            entity,
            byte[].class
        );
        
        return response.getBody();
    }
    
    /**
     * Lista jobs completados
     */
    public List<CompletedJob> listCompletedJobs() {
        String url = scrapingApiUrl + "/api/v1/scraping/completed";
        
        HttpHeaders headers = new HttpHeaders();
        headers.set("X-API-Key", apiKey);
        
        HttpEntity<Void> entity = new HttpEntity<>(headers);
        
        ResponseEntity<CompletedJob[]> response = restTemplate.exchange(
            url,
            HttpMethod.GET,
            entity,
            CompletedJob[].class
        );
        
        return Arrays.asList(response.getBody());
    }
}
```

### DTOs

```java
@Data
@Builder
public class ScrapingRequest {
    private int year;
    private String month;
    private String prestador;
}

@Data
public class ScrapingResponse {
    private String jobId;
    private String message;
    private int estimatedTimeMinutes;
    private String sftpPath;
}

@Data
public class CompletedJob {
    private String jobId;
    private String completedAt;
    private int filesCount;
    private String csvUrl;
}
```

### Configuration

```java
@Configuration
public class RestConfig {
    
    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

### application.yml

```yaml
scraping:
  api:
    url: https://scraping-api.railway.app
    key: ${SCRAPING_API_KEY}
```

---

## ğŸš€ Despliegue en Railway

### Estructura del Proyecto

```
scrapper-mvp/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py           # FastAPI app
â”‚   â”œâ”€â”€ tasks.py          # RQ/Celery tasks
â”‚   â”œâ”€â”€ config.py         # Settings
â”‚   â””â”€â”€ sftp.py           # SFTP client
â”œâ”€â”€ scraper/
â”‚   â”œâ”€â”€ cruzblanca.py     # Scraper
â”‚   â”œâ”€â”€ extractor.py      # PDF extractor
â”‚   â”œâ”€â”€ pdf_parser.py     # PDF parser
â”‚   â””â”€â”€ pdf_validator.py  # Validator
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ Procfile              # Railway config
â””â”€â”€ runtime.txt           # Python version
```

### Procfile

```procfile
# API Service
web: uvicorn app.main:app --host 0.0.0.0 --port $PORT

# Worker Service (si usas RQ)
worker: rq worker --url $UPSTASH_REDIS_URL

# Worker Service (si usas Celery)
# worker: celery -A app.celery_app worker --loglevel=info
```

### requirements.txt

```txt
fastapi==0.109.0
uvicorn[standard]==0.27.0
pydantic==2.5.0
pydantic-settings==2.1.0

# Queue (elegir una)
rq==1.16.0              # OpciÃ³n simple
# celery==5.3.6         # OpciÃ³n robusta

# Redis
redis==5.0.1

# Scraping & Extraction
playwright==1.42.0
pdfplumber==0.10.3

# SFTP
paramiko==3.4.0

# Utilities
python-dotenv==1.0.0
httpx==0.26.0
```

### Variables de Entorno en Railway

```bash
# API
PORT=8000
ENVIRONMENT=production

# Redis (Upstash)
UPSTASH_REDIS_URL=redis://default:xxx@xxx.upstash.io:6379

# SFTP (Digital Ocean)
SFTP_HOST=your-server.digitalocean.com
SFTP_PORT=22
SFTP_USER=your-username
SFTP_PASSWORD=your-password
SFTP_BASE_PATH=/scraping_data

# Security
API_KEY=your-secret-api-key

# Scraping
CAPTCHA_TIMEOUT=300
MAX_RETRIES=3
```

### Deploy

```bash
# 1. Instalar Railway CLI
npm install -g @railway/cli

# 2. Login
railway login

# 3. Init proyecto
railway init

# 4. Link a proyecto existente (si ya existe)
railway link

# 5. Deploy
railway up

# 6. Ver logs
railway logs
```

---

## ğŸ“ Estructura de Archivos en SFTP

```
/scraping_data/
â”œâ”€â”€ febrero_2025_1729634567/
â”‚   â”œâ”€â”€ pdfs/
â”‚   â”‚   â”œâ”€â”€ row_1_19_xxx.pdf
â”‚   â”‚   â”œâ”€â”€ row_2_19_xxx.pdf
â”‚   â”‚   â””â”€â”€ ... (57 archivos)
â”‚   â”œâ”€â”€ json/
â”‚   â”‚   â”œâ”€â”€ row_1_19_xxx.json
â”‚   â”‚   â”œâ”€â”€ row_2_19_xxx.json
â”‚   â”‚   â”œâ”€â”€ ... (57 archivos)
â”‚   â”‚   â””â”€â”€ _reporte_extraccion.json
â”‚   â”œâ”€â”€ reports/
â”‚   â”‚   â””â”€â”€ consolidado.csv
â”‚   â””â”€â”€ metadata/
â”‚       â”œâ”€â”€ job_info.json
â”‚       â””â”€â”€ scraping_metadata.csv
â”œâ”€â”€ marzo_2025_1729634890/
â”‚   â””â”€â”€ ...
â””â”€â”€ abril_2025_1729635123/
    â””â”€â”€ ...
```

### Nomenclatura de Jobs

```
{month}_{year}_{timestamp}

Ejemplos:
- febrero_2025_1729634567
- marzo_2025_1729634890
- abril_2025_1729635123
```

---

## ğŸ¯ Decisiones de DiseÃ±o

### 1. Fire & Forget vs Polling

**DecisiÃ³n:** Fire & Forget

**Razones:**
- âœ… Simplicidad en el frontend
- âœ… No requiere WebSockets
- âœ… SFTP es la fuente de verdad
- âœ… No necesita monitoreo en tiempo real
- âŒ Usuario debe esperar sin feedback

**Alternativa (futura):**
- Webhook a Spring cuando job completa
- NotificaciÃ³n al usuario vÃ­a email/push

---

### 2. RQ vs Celery

**DecisiÃ³n:** RQ (recomendado)

**Razones:**
- âœ… MÃ¡s simple que Celery
- âœ… Suficiente para el caso de uso
- âœ… Menos recursos
- âœ… FÃ¡cil de debuggear
- âœ… Retry automÃ¡tico

**CuÃ¡ndo usar Celery:**
- MÃºltiples tipos de jobs complejos
- Necesidad de scheduling (cron)
- Monitoreo avanzado requerido

---

### 3. Storage: SFTP vs S3

**DecisiÃ³n:** SFTP (Digital Ocean)

**Razones:**
- âœ… Ya existe en la infraestructura
- âœ… Spring ya tiene cliente SFTP
- âœ… Sin costo adicional
- âŒ Menos escalable que S3

**MigraciÃ³n futura a S3:**
- Sencilla (cambiar solo mÃ³dulo de storage)
- Mantener SFTP como backup

---

### 4. AutenticaciÃ³n

**DecisiÃ³n:** API Key en Header

**ImplementaciÃ³n:**
```python
from fastapi import Header, HTTPException

async def verify_api_key(x_api_key: str = Header(...)):
    if x_api_key != settings.API_KEY:
        raise HTTPException(status_code=401, detail="Invalid API key")
    return x_api_key
```

**Alternativa futura:**
- JWT tokens
- OAuth2

---

### 5. Manejo de Errores

**Strategy:**
- Retry automÃ¡tico (3 intentos)
- Guardar logs en SFTP
- Estado del job en Redis
- NotificaciÃ³n de error (futuro)

```python
@queue.job('default', timeout='30m', result_ttl=86400, failure_ttl=86400)
def run_pipeline(job_id, year, month, prestador):
    try:
        # 1. Scraping
        result = scraper.run(...)
        
        # 2. Extraction
        jsons = extractor.run(...)
        
        # 3. Report
        csv = reporter.run(...)
        
        # Guardar estado
        save_job_status(job_id, "completed")
        
    except Exception as e:
        log.error(f"Job {job_id} failed: {e}")
        save_job_status(job_id, "failed", error=str(e))
        raise
```

---

## ğŸ“ˆ Roadmap Futuro

### Fase 1: MVP (Actual)
- [x] Scraper funcional
- [x] Extractor con validaciÃ³n
- [x] Generador de reportes CSV
- [ ] API REST bÃ¡sica
- [ ] Deploy en Railway

### Fase 2: ProducciÃ³n
- [ ] Queue con RQ
- [ ] Retry automÃ¡tico
- [ ] Logs estructurados
- [ ] MÃ©tricas bÃ¡sicas

### Fase 3: Mejoras
- [ ] Webhook a Spring al completar
- [ ] Dashboard de monitoreo
- [ ] Scheduling automÃ¡tico (ej: cada mes)
- [ ] Multi-prestador en paralelo

### Fase 4: Escalabilidad
- [ ] MigraciÃ³n a S3
- [ ] Cache de resultados
- [ ] API de bÃºsqueda de liquidaciones
- [ ] IntegraciÃ³n con DB (PostgreSQL)

---

## ğŸ”§ Mantenimiento

### Logs

```bash
# Railway logs
railway logs --service scraping-api
railway logs --service scraping-workers

# Logs locales (desarrollo)
tail -f logs/scraping.log
```

### Debugging

```python
# Modo debug
import logging
logging.basicConfig(level=logging.DEBUG)

# Test SFTP
python -m app.sftp --test

# Test scraper
python -m scraper.cruzblanca --year 2025 --month FEBRERO
```

### Monitoreo

```bash
# Ver jobs en Redis
redis-cli -u $UPSTASH_REDIS_URL
> KEYS *
> GET job:123456

# RQ dashboard
rq info --url $UPSTASH_REDIS_URL
```

---

## ğŸ“‹ Plan de MigraciÃ³n

### Estado Actual del Sistema

El sistema actual tiene los siguientes componentes funcionales:

```
FASE ACTUAL (Local + Manual)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… Scraper Cruz Blanca (scraper/cruzblanca.py)
   - Playwright local
   - Login manual en navegador local
   - Descarga PDFs a data/pdfs/
   - Extrae tabla a CSV

âœ… PDF Extractor (scraper/pdf_parser.py + extractor.py)
   - Parse con pdfplumber
   - ValidaciÃ³n con JSON schema
   - 100% success rate (57/57 PDFs)

âœ… Report Generator (scripts/generate_report.py)
   - Consolida JSONs â†’ CSV
   - Calcula totales

âœ… CLI Scripts
   - scripts/scrape.py (solo scraping)
   - scripts/extract_batch.py (solo extracciÃ³n)
```

**Limitaciones actuales:**
- Requiere instalaciÃ³n local de Playwright
- No es una API (solo CLI)
- Sin SFTP (solo filesystem local)
- Sin persistencia en BD
- 1 usuario a la vez
- Sin observabilidad

---

### Roadmap de MigraciÃ³n

#### Fase 1: API BÃ¡sica (1-2 semanas)
**Objetivo:** Convertir CLI a API REST con "Fire & Forget"

**Cambios:**
```
1. Crear FastAPI app (api/main.py)
2. Implementar endpoints:
   - POST /api/v1/scraping/trigger
   - GET /api/v1/files/{job_id}/reports/{filename}
3. Integrar RQ para tasks asÃ­ncronas
4. Conectar Upstash Redis
5. Deploy en Railway (2 servicios: API + Worker)
```

**Arquitectura Fase 1:**
```
Usuario â†’ Spring â†’ Scraper API â†’ Redis Queue â†’ Worker
                                                   â†“
                                          Local filesystem
                                          (data/pdfs, data/json)
```

**Mantiene:**
- âœ… Login manual en navegador local
- âœ… Playwright local
- âœ… Filesystem local

**Agrega:**
- âœ… API REST
- âœ… Task queue
- âœ… Deploy en cloud

**Criterio de Ã©xito:**
- Spring puede gatillar el proceso via POST
- Worker procesa en background
- API retorna archivos generados

---

#### Fase 2: SFTP Integration (1 semana)
**Objetivo:** Mover archivos de filesystem local a SFTP

**Cambios:**
```
1. Implementar SFTP client (usando postman_collection.json)
2. Modificar Worker para subir archivos:
   - PDFs â†’ /scraping_data/{job_id}/pdfs/
   - JSONs â†’ /scraping_data/{job_id}/json/
   - CSV â†’ /scraping_data/{job_id}/reports/
3. Implementar endpoint para download desde SFTP
4. (Opcional) Mantener cache local temporal
```

**Arquitectura Fase 2:**
```
Usuario â†’ Spring â†’ Scraper API â†’ Redis Queue â†’ Worker
                                                   â†“
                                             Local (temp)
                                                   â†“
                                                 SFTP
                                            (Digital Ocean)
```

**Mantiene:**
- âœ… Login manual en navegador local
- âœ… Playwright local

**Agrega:**
- âœ… Persistencia en SFTP
- âœ… Archivos centralizados
- âœ… Acceso desde Spring

**Criterio de Ã©xito:**
- Worker sube todos los archivos a SFTP
- Spring puede descargar archivos desde SFTP
- Sin archivos huÃ©rfanos en local

---

#### Fase 3: PostgreSQL Persistence (1 semana)
**Objetivo:** Persistir datos estructurados en BD

**Cambios:**
```
1. DiseÃ±ar schema PostgreSQL:
   - tabla: scraping_jobs
   - tabla: extracted_data (JSON normalizado)
   - tabla: audit_logs
2. Implementar repository layer
3. Modificar Worker para persistir:
   - Metadata del job
   - Datos extraÃ­dos de JSONs
   - Logs y mÃ©tricas
4. Agregar endpoints de query:
   - GET /api/v1/data/search?month=FEBRERO&year=2025
```

**Arquitectura Fase 3:**
```
Usuario â†’ Spring â†’ Scraper API â†’ Redis Queue â†’ Worker
                                                   â†“
                                             PostgreSQL
                                                   +
                                                 SFTP
```

**Mantiene:**
- âœ… Login manual en navegador local
- âœ… Playwright local
- âœ… SFTP para archivos

**Agrega:**
- âœ… BD relacional
- âœ… Queries sobre datos
- âœ… AuditorÃ­a

**Criterio de Ã©xito:**
- Datos en BD con integridad referencial
- Spring puede consultar datos sin SFTP
- Dashboard bÃ¡sico de mÃ©tricas

---

#### Fase 4: Navegador Remoto (2-3 semanas) â­
**Objetivo:** Eliminar dependencia de instalaciÃ³n local

**Cambios:**
```
1. Setup infraestructura navegador remoto:
   - OpciÃ³n A: Browserless.io ($79/mes)
   - OpciÃ³n B: Self-host Docker (chrome + noVNC)
2. Modificar endpoint /run:
   - Crear sesiÃ³n Chrome remoto
   - Retornar login_url (viewer)
3. Implementar detecciÃ³n de login OK:
   - Polling en URL/selector
   - Captura de storageState
4. Modificar Worker:
   - Usar storageState en lugar de login manual
   - 100% headless
5. Implementar seguridad:
   - Cifrado de storageState
   - TTL de sesiones
```

**Arquitectura Fase 4 (OBJETIVO):**
```
Usuario â†’ Spring â†’ Scraper API â†’ Chrome Remoto (viewer)
                        â†“                    â†“
                   Redis Queue         storageState
                        â†“                    â†“
                     Worker (headless con storage)
                        â†“
                  PostgreSQL + SFTP
```

**Elimina:**
- âŒ InstalaciÃ³n local de Playwright
- âŒ Login manual en navegador del usuario
- âŒ Dependencia de UI local

**Agrega:**
- âœ… Zero-install para usuarios
- âœ… Navegador controlado por backend
- âœ… SesiÃ³n reutilizable
- âœ… Multi-tenancy real
- âœ… Worker 100% headless

**Criterio de Ã©xito:**
- Usuario solo ve popup con viewer
- Backend controla 100% navegador
- Worker procesa con storageState
- Sin instalaciones en PC usuario
- MÃºltiples usuarios simultÃ¡neos

---

#### Fase 5: Observabilidad (1 semana)
**Objetivo:** Feedback en tiempo real a usuarios

**Cambios:**
```
1. Implementar state tracking en Redis:
   - pending â†’ scraping â†’ extracting â†’ reporting â†’ completed
2. Agregar endpoints de estado:
   - GET /api/v1/scraping/jobs/{job_id}
3. Worker actualiza progreso:
   - % de PDFs descargados
   - % de JSONs procesados
4. Spring implementa polling cada 5s
```

**Arquitectura Fase 5:**
```
Usuario â†’ Spring (polling cada 5s)
            â†“
       Scraper API (GET /jobs/{id})
            â†“
       Redis (job state)
            â†‘
         Worker (actualiza estado)
```

**Agrega:**
- âœ… Progress bars
- âœ… ETA de finalizaciÃ³n
- âœ… DetecciÃ³n temprana de errores
- âœ… UX mejorada

**Criterio de Ã©xito:**
- Usuario ve progreso en tiempo real
- Spring muestra % de avance
- Errores se detectan inmediatamente

---

### ComparaciÃ³n de Fases

| CaracterÃ­stica | Actual | Fase 1 | Fase 2 | Fase 3 | Fase 4 | Fase 5 |
|----------------|--------|--------|--------|--------|--------|--------|
| **API REST** | âŒ | âœ… | âœ… | âœ… | âœ… | âœ… |
| **Task Queue** | âŒ | âœ… | âœ… | âœ… | âœ… | âœ… |
| **SFTP** | âŒ | âŒ | âœ… | âœ… | âœ… | âœ… |
| **PostgreSQL** | âŒ | âŒ | âŒ | âœ… | âœ… | âœ… |
| **Navegador Remoto** | âŒ | âŒ | âŒ | âŒ | âœ… | âœ… |
| **Zero Install** | âŒ | âŒ | âŒ | âŒ | âœ… | âœ… |
| **Observabilidad** | âŒ | âŒ | âŒ | âŒ | âŒ | âœ… |
| **Multi-user** | âŒ | âš ï¸ | âš ï¸ | âš ï¸ | âœ… | âœ… |
| **Complejidad** | â­ | â­â­ | â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |

---

### DecisiÃ³n: QuÃ© Fase Implementar

#### RecomendaciÃ³n por Contexto

**Si necesitas:**
- **MVP funcional rÃ¡pido** â†’ Fase 1 (API BÃ¡sica)
- **Archivos centralizados** â†’ Fase 2 (+ SFTP)
- **Queries sobre datos** â†’ Fase 3 (+ PostgreSQL)
- **Producto SaaS escalable** â†’ Fase 4 (+ Navegador Remoto)
- **UX premium** â†’ Fase 5 (+ Observabilidad)

**Ruta sugerida para este proyecto:**
```
Actual â†’ Fase 1 (2 semanas) â†’ Validar con usuarios
              â†“
         Fase 2 (1 semana) â†’ Deploy a producciÃ³n limitada
              â†“
         Fase 3 (1 semana) â†’ Queries y dashboards
              â†“
         Fase 4 (3 semanas) â†’ Producto escalable
              â†“
         Fase 5 (1 semana) â†’ UX final
```

**Total:** ~8-10 semanas para el producto completo

---

### Riesgos y Mitigaciones

#### Fase 1-3 (API + SFTP + BD)
**Riesgos:**
- Login manual sigue siendo bottleneck
- Solo 1 usuario simultÃ¡neo realista

**Mitigaciones:**
- Documentar flujo de login claramente
- Implementar colas (si user A usa, user B espera)

---

#### Fase 4 (Navegador Remoto)
**Riesgos:**
- Complejidad alta
- Debuggeo mÃ¡s difÃ­cil
- Costos de infraestructura

**Mitigaciones:**
- Empezar con Browserless.io (gestionado)
- POC pequeÃ±o antes de migraciÃ³n completa
- Mantener cÃ³digo local como fallback
- Logs exhaustivos + screenshots automÃ¡ticos

---

#### Fase 5 (Observabilidad)
**Riesgos:**
- Carga adicional en Redis
- Polling consume requests

**Mitigaciones:**
- Usar WebSockets en lugar de polling (opcional)
- CachÃ© de estados (actualizar cada 5s, no por request)
- Rate limiting en endpoints de estado

---

### Checklist Pre-MigraciÃ³n

Antes de iniciar Fase 1, asegurarse de:

```
âœ… DocumentaciÃ³n actual completa
   - âœ… README.md actualizado
   - âœ… EXTRACTOR_COMPLETADO.md existe
   - âœ… ARQUITECTURA_MICROSERVICIO.md creado

âœ… Tests bÃ¡sicos
   - âœ… Scraper funciona con Febrero 2025
   - âœ… Extractor 100% success rate
   - âœ… CSV consolidado genera correctamente

âœ… Backup del cÃ³digo actual
   - âœ… Git tag "v1-local-cli"
   - âœ… Branch "pre-api-migration"

âœ… Infraestructura lista
   - âœ… Railway account
   - âœ… Upstash Redis account
   - âœ… Digital Ocean SFTP access
   - (Fase 3) PostgreSQL provisioning

âœ… Spring preparado
   - âœ… Endpoints de trigger definidos
   - âœ… Auth (API key) diseÃ±ado
```

---

### Siguiente Paso Recomendado

**AcciÃ³n inmediata:** Implementar Fase 1 (API BÃ¡sica)

**Por quÃ©:**
- Desbloquea integraciÃ³n con Spring
- No requiere cambios arquitectÃ³nicos grandes
- Mantiene scraper actual funcionando
- Railway/Upstash son gratis inicialmente
- ROI inmediato (Spring puede gatillar proceso)

**Tareas concretas:**
1. Crear `api/` directory
2. Implementar FastAPI app con `/trigger` endpoint
3. Integrar RQ + Upstash Redis
4. Deploy en Railway (proof of concept)
5. Probar end-to-end: Spring â†’ API â†’ Worker â†’ archivos

**Estimado:** 1-2 semanas part-time

---

## ğŸ“ Notas Finales

1. **CAPTCHA Manual:** El scraper requiere intervenciÃ³n manual para resolver el CAPTCHA de Cruz Blanca. Esto es intencional dado que el CAPTCHA es complejo.

2. **Tiempo de Procesamiento:** Estimado 5-10 minutos para ~60 PDFs. Ajustar `job_timeout` en RQ si es necesario.

3. **LÃ­mites de Upstash:** Free tier tiene 10K comandos/dÃ­a. Suficiente para ~100 jobs/dÃ­a. Monitorear uso.

4. **Railway Limits:** Plan gratuito tiene $5/mes de crÃ©dito. Suficiente para desarrollo. Considerar plan Pro ($5/mes) para producciÃ³n.

5. **Nombres de PDFs:** Actualmente son aleatorios (`row_X_Y_HASH.pdf`). Para vincular con CSVs de metadata, considerar nombres determinÃ­sticos en el futuro.

---

## ğŸ“ Contacto y Soporte

Para dudas sobre implementaciÃ³n, revisar:
- `EXTRACTOR_COMPLETADO.md` - DocumentaciÃ³n del extractor
- `README.md` - GuÃ­a general del proyecto
- Logs en Railway

---

**Ãšltima actualizaciÃ³n:** 2025-10-22
**VersiÃ³n:** 2.0
**Estado:** Arquitectura completa con roadmap de migraciÃ³n en 5 fases

